<!DOCTYPE html>
<html lang="es">
<head>
  <!-- [All the head content remains exactly the same] -->
  <style>
    /* [All CSS remains exactly the same, including the new #now-playing a styles] */
  </style>
</head>
<body>
  <!-- [All body content remains exactly the same until the script] -->

  <script>
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);

    let player;
    const titleDiv = document.getElementById('now-playing');
    let hasStarted = false;
    let currentVideoId = '';
    let currentVideoTitle = '';

    function getCleanVideoUrl() {
      // Use the stored video ID if we have it
      if (currentVideoId) {
        return `https://www.youtube.com/watch?v=${currentVideoId}`;
      }
      
      // Fallback to player.getVideoUrl() if available
      if (!player || !player.getVideoUrl) return '';
      const fullUrl = player.getVideoUrl();
      try {
        const url = new URL(fullUrl);
        const videoId = url.searchParams.get('v');
        return videoId ? `https://www.youtube.com/watch?v=${videoId}` : fullUrl;
      } catch {
        return fullUrl;
      }
    }

    function createShareLink(title) {
      // Only create link if we have a real title
      if (!title || title === 'Reproduciendo...' || title === '') {
        return title || 'Reproduciendo...';
      }
      
      const videoUrl = getCleanVideoUrl();
      const shareText = `${title} â†’ ${videoUrl}`;
      const encodedText = encodeURIComponent(shareText);
      const twitterUrl = `https://x.com/intent/tweet?text=${encodedText}`;
      
      return `<a href="${twitterUrl}" target="_blank" rel="noopener noreferrer">${title}</a>`;
    }

    function updateTitle() {
      if (!player || !player.getVideoData) return;
      const data = player.getVideoData();
      const title = data?.title || '';
      const videoId = data?.video_id || '';
      
      // Store the video ID for later use
      if (videoId) {
        currentVideoId = videoId;
      }
      
      // Only update if we have a valid title
      if (title && title !== '') {
        currentVideoTitle = title;
        titleDiv.innerHTML = createShareLink(title);
        titleDiv.classList.add('show');
      } else if (currentVideoTitle) {
        // Show the last known title if available
        titleDiv.innerHTML = createShareLink(currentVideoTitle);
        titleDiv.classList.add('show');
      } else {
        // Fallback to plain text
        titleDiv.textContent = 'Reproduciendo...';
        titleDiv.classList.add('show');
      }
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '1', width: '1',
        playerVars: {
          listType: 'playlist',
          list: 'PLQnQS1Xke-YjCiBFK6Ym6W8JQrgUIxd6p',
          loop: 1,
          playlist: 'PLQnQS1Xke-YjCiBFK6Ym6W8JQrgUIxd6p',
          controls: 0, modestbranding: 1, rel: 0, iv_load_policy: 3, disablekb: 1, autoplay: 0
        },
        events: {
          'onReady': () => {},
          'onStateChange': e => {
            const playing = e.data === YT.PlayerState.PLAYING;
            document.getElementById('play').classList.toggle('playing', playing);
            if (e.data === YT.PlayerState.PLAYING || e.data === YT.PlayerState.PAUSED) {
              setTimeout(updateTitle, 400);
            }
          }
        }
      });
    }

    document.getElementById('play').onclick = () => {
      if (hasStarted) {
        player.playVideo();
        return;
      }

      hasStarted = true;

      player.setShuffle(true);
      const playlist = player.getPlaylist();
      const randomIndex = Math.floor(Math.random() * (playlist ? playlist.length : 1));
      player.playVideoAt(randomIndex);
      player.playVideo();
      setTimeout(updateTitle, 700);
    };

    document.getElementById('pause').onclick = () => player.pauseVideo();
    document.getElementById('prev').onclick   = () => { player.previousVideo(); setTimeout(updateTitle, 800); };
    document.getElementById('next').onclick   = () => { player.nextVideo(); setTimeout(updateTitle, 800); };
    document.getElementById('first').onclick  = () => { player.playVideoAt(0); setTimeout(updateTitle, 800); };
    document.getElementById('last').onclick   = () => {
      const list = player.getPlaylist();
      if (list?.length) player.playVideoAt(list.length - 1);
      setTimeout(updateTitle, 800);
    };
    
    setInterval(() => { if (hasStarted) updateTitle(); }, 5000);
  </script>

</body>
</html>
